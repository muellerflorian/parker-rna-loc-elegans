<docs lang="markdown">
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "GranuleColocalization",
  "type": "native-python",
  "version": "0.1.4",
  "description": "Plugin to analyze colocalization of RNA clusters and cellular granules.",
  "tags": ["stable","dev"],
  "ui": [],
  "cover": "",
  "inputs": null,
  "outputs": null,
  "flags": [],
  "icon": "border_outer",
  "api_version": "0.1.5",
  "env": "conda create -n rna-localization python=3.6",
  "requirements": { "stable":[
                                "pip: scikit-image scikit-learn matplotlib_venn seaborn pandas",
                                "pip: -U git+https://github.com/muellerflorian/parker-rna-loc-elegans@4c6e4ed#egg=rnaloc"
                              ],
                    "dev": [
                                "pip: scikit-image scikit-learn matplotlib_venn seaborn pandas",
                                "pip: --editable /Volumes/PILON_HD2/fmueller/Documents/code/projects/parker-rna-loc-elegans"
                            ]},
  "dependencies": []
}
</config>

<script lang="python">
from imjoy import api

import sys
import os
import asyncio
import base64
import json
import copy
import numpy as np

if sys.platform == "darwin":
    import matplotlib
    matplotlib.use('PS')

from rnaloc import granule_coloc
from rnaloc import utils

class ImJoyPlugin():

    async def setup(self):

        # Set root folder
        path_root = await api.getConfig('root_folder_granules')

        if path_root:
            self.root=path_root
        else:
            self.root='~'

        # Operation to specify root folder
        api.register({
            "name": "Root folder",
            "ui": "Define root folder to load files.",
            "run":self.set_root,
            "type": "op"
        })

        # Load data
        api.register({
            "name": "Load data",
            "ui": [
                    {"Channel ident [FISH]": {"id": "ch_ident_fish","type": "string", "placeholder": 'C1'}},
                    {"Channel ident [GRANULES]": {"id": "ch_ident_granules","type": "string", "placeholder": 'C3'}},
            ],
            "run":self.load_data,
            "type": "op"
        })

        # Specify granule threshold
        api.register({
            "name": "Test granule threshold",
            "ui": [
                    {"Blobs threshold": {"id": "blobs_threshold","type": "number", "placeholder": 0.001,'min':0}},
            ],
            "run":self.detect_blobs_2d,
            "type": "op"
        })

        # Specify granule threshold
        api.register({
            "name": "Detect granules in 3D",
            "ui": 'This can take a bit longer.',
            "run":self.detect_blobs_3d,
            "type": "op"
        })


        # Specify DB scan settings
        api.register({
            "name": "Perform DB scan",
            "ui": [
                    {"Eps": {"id": "eps","type": "number", "placeholder": 500,'min':0}},
                    {"Min samples": {"id": "min_samples","type": "number", "placeholder": 5,'min':0}},
            ],
            "run":self.dbscan_test,
            "type": "op"
        })


        # Specify DB scan settings
        api.register({
            "name": "Analyze co-localization",
            "ui": ['Use specified settings to determine co-localization.'],
            "run":self.analyze_coloc,
            "type": "op"
        })
        api.log(' ')
        api.log('== GranuleColocalization: initialized')
        api.log(f'Plugin is running with tag: {api.TAG}')


    async def run(self, ctx):
        api.showStatus('Nuclear Membrane Enrichment Plugin: FINISHED!')

    # Set root folder
    async def set_root(self,ctx):

        ret = await api.showFileDialog(title="Specify a root folder to initiate future file dialogs.", type="directory",root=self.root)
        if ret:
            root_folder = ret['path']
            if os.path.isdir(root_folder):
                self.root = root_folder
                api.setConfig('root_folder_granules', root_folder)
                api.log(f'Root folder set to {root_folder}')    

    # Load data
    async def load_data(self,ctx):

        # Ask for FQ results file
        ret = await api.showFileDialog(title="Select FQ results file.",type="file",root=self.root,mode='single')
        if ret:
            file_load = ret['path']
            drive, path, file_base, ext = utils.file_name_decompose(file_load)
            path_FQ = os.path.join(drive,path)
            file_FQ = file_base+ext
            
        # Determine folders with images and to store results
        channel_identifier = (ctx.config.ch_ident_fish,ctx.config.ch_ident_granules)
        path_project = granule_coloc.get_folders(
                        path_project = {
                                'FQ': path_FQ,
                                'save': '',
                                'img_granules': '',
                                'img_RNA': '',
                        },
                        channel_identifier=channel_identifier
        )
        api.log('Project folders defined. See Engine for more detail.')
        print('[GranuleColocalization][load_data]: project folders')
        print(path_project)

        # Read data
        spots_all, spots_all_pix, img_FISH, img_granules = granule_coloc.read_data(
                file_FQ=file_FQ,
                channel_identifier=channel_identifier,
                path_project=path_project)

        api.log('Results loaded.')

        # Store data
        self.file_FQ = file_FQ      
        self.path_project = path_project
        self.channel_identifier = channel_identifier

        self.spots_all = spots_all
        self.spots_all_pix = spots_all_pix

        self.img_FISH = img_FISH
        self.img_granules = img_granules
        self.img_granules_MIP = img_granules.max(axis=0)
        self.img_FISH_MIP = img_FISH.max(axis=0)

        api.showStatus('Data loaded!')


    #  Set detection settings for blobs in 2D
    async def detect_blobs_2d(self,ctx):
        api.showStatus('Testing granule detection threshold in 2D.')
        blobs_method = 'log'
        blobs_threshold = ctx.config.blobs_threshold

        name_save = os.path.join(self.path_project['save'], f'2D_blob_detection__{blobs_method}-{blobs_threshold}.png')
        granule_coloc.detect_blobs_2d(
                    img=self.img_granules_MIP,
                    blobs_threshold=blobs_threshold,
                    blobs_method=blobs_method,
                    show_plot=False,
                    name_save=name_save)

        with open(name_save, 'rb') as f:
            data = f.read()
            result = base64.b64encode(data).decode('ascii')
            imgurl = 'data:image/png;base64,' + result

            win = await api.createWindow(
                    name=f'Blob_detection__{blobs_method}-{blobs_threshold}', 
                    type='imjoy/image',
                    w=12, h=15, 
                    data= {"src": imgurl}
            )
        self.blobs_threshold = blobs_threshold
        self.blobs_method =  blobs_method
        api.showStatus('Done with testing granule detection threshold in 2D.')
        
    #  Detect blobs in 3D
    async def detect_blobs_3d(self,ctx):
        
        blobs_threshold = self.blobs_threshold
        blobs_method =  self.blobs_method

        api.showStatus('Detecting granules in 3D. This can take bit of time ...')
        img_granules_label, df_granules = granule_coloc.detect_blobs_3d(
                            img=self.img_granules,
                            blobs_threshold=blobs_threshold,
                            blobs_method=blobs_method,
                            show_plot=False,
                            path_save=self.path_project['save'])

        self.img_granules_label = img_granules_label
        self.df_granules = df_granules
        api.showStatus('Granule detection finished!')


    #  Test DB scan parameters
    async def dbscan_test(self,ctx):
        api.showStatus('Finding cluster with DB-scan.')
        eps = ctx.config.eps
        min_samples=ctx.config.min_samples
        name_save = os.path.join(self.path_project['save'], f'DB_scan_eps-{eps}__min-samples-{min_samples}.png')
        
        RNA_clusters = granule_coloc.dbscan_apply(
                        pos=self.spots_all,
                        eps=eps,
                        min_samples=min_samples,
                        img_2d=self.img_FISH_MIP,
                        show_plot=False,
                        name_save=name_save)

        self.RNA_clusters = RNA_clusters
        self.min_samples = min_samples
        self.eps = eps

        with open(name_save, 'rb') as f:
            data = f.read()
            result = base64.b64encode(data).decode('ascii')
            imgurl = 'data:image/png;base64,' + result

            win = await api.createWindow(
                    name=f'DB_scan_eps-{eps}__min-samples-{min_samples}', 
                    type='imjoy/image',
                    w=12, h=15, 
                    data= {"src": imgurl}
            )
        
        api.showStatus('Done with finding cluster with DB-scan!')

    async def analyze_coloc(self,ctx):

        
        # DBscan: analyze last analysis
        api.showStatus('Analyzing DB-scan results in more detail ....')
        img_clusters_label, df_clusters = granule_coloc.dbscan_analyze(
                clusters=self.RNA_clusters,
                img=self.img_FISH,
                pos=self.spots_all_pix,
                show_plot=False,
                path_save=self.path_project['save'])

        #Analyze co-localization
        api.showStatus('Looking at colocalization between clusters and granules ....')
        df_clusters, df_granules = granule_coloc.analyze_coloc(
                        clusters_label=img_clusters_label,
                        granules_label=self.img_granules_label,
                        df_clusters=df_clusters,
                        df_granules=self.df_granules,
                        img_granules=self.img_granules_MIP,
                        img_clusters=self.img_FISH_MIP,
                        show_plot=False,
                        path_save=self.path_project['save'])

        api.showStatus(f"Done! Results are here: {self.path_project['save']}")
api.export(ImJoyPlugin())
</script>
